<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KPI Dashboard</title>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

/* ===================== ICONS ===================== */

const Calculator = () => (
<svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2">
    <rect x="4" y="2" width="16" height="20" rx="2"/>
    <line x1="8" y1="6" x2="16" y2="6"/>
</svg>
);

const RefreshCw = ({ className }) => (
<svg className={className} width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2">
    <polyline points="23 4 23 10 17 10"/>
    <polyline points="1 20 1 14 7 14"/>
    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
</svg>
);

const AlertCircle = () => (
<svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2">
    <circle cx="12" cy="12" r="10"/>
    <line x1="12" y1="8" x2="12" y2="12"/>
    <line x1="12" y1="16" x2="12.01" y2="16"/>
</svg>
);

/* ===================== MAIN COMPONENT ===================== */

function PerformanceTracker() {

const [data, setData] = useState([]);
const [insPmtData, setInsPmtData] = useState([]);
const [productionData, setProductionData] = useState([]);
const [uniqueNames, setUniqueNames] = useState([]);
const [selectedName, setSelectedName] = useState('');
const [startDate, setStartDate] = useState('');
const [endDate, setEndDate] = useState('');
const [loading, setLoading] = useState(false);
const [error, setError] = useState('');
const [lastUpdated, setLastUpdated] = useState(null);
const [showUnlistedTasks, setShowUnlistedTasks] = useState(false);

/* ===================== CONSTANTS ===================== */

const departments = {
    'AR Department': ['AD','AB','BDZ','BZ','GA','GG','HGB','IS','JA','JM','JS','KPM','LG','MB','MGS','NB','PT','RM','SPA','MCB','MA','VR','RD','LSA'],
    'Outbound Department': ['AMD','BM','CB','CC','CDC','DMA','ED','EMP','GC','GD','GP','HMA','IM','ISC','JC','JI','JL','JP','JRC','LL','LV','NZ','PB','RG','SMS','VL','WM'],
    'Verification Department': ['CF','GZ','JCB','JTL','KR','MLC','RS']
};

const allAllowedNames = Object.values(departments).flat();

const employeeStateAssignments = {
    AD:'Alaska',AB:'Alaska',BDZ:'Washington',BZ:'California',GA:'Washington',
    GG:'Washington',HGB:'Washington',IS:'Washington',JA:'Washington',
    JM:'Alaska',JS:'California',KPM:'Washington',LG:'Alaska',
    MB:'Washington',MGS:'Washington',NB:'California',PT:'Alaska',
    RM:'Alaska',SPA:'Washington',MCB:'Washington',MA:'Washington',
    VR:'Alaska',RD:'Washington',LSA:'Washington',

    AMD:'Washington',BM:'Alaska',CB:'Alaska',CC:'Washington',
    CDC:'Washington',DMA:'Alaska',ED:'Washington',EMP:'Alaska',
    GC:'Alaska',GD:'Washington',GP:'Washington',HMA:'Washington',
    IM:'Washington',ISC:'Washington',JC:'Alaska',JI:'Washington',
    JL:'Alaska',JP:'Washington',JRC:'Washington',LL:'Washington',
    LV:'Washington',NZ:'Alaska',PB:'Alaska',RG:'Washington',
    SMS:'Washington',VL:'Washington',WM:'Washington',

    CF:'Alaska',GZ:'Alaska',JCB:'Washington',JTL:'Washington',
    KR:'Washington',MLC:'Alaska',RS:'Washington'
};

const stateGoals = {
    Alaska: { collection: 10389, production: 12269, verification: 50 },
    Washington: { collection: 11553, production: 11039, verification: 50 },
    California: { collection: 4545, production: 95000, verification: 50 }
};

/* ===================== HELPERS ===================== */

const getDepartment = name =>
Object.entries(departments).find(([,list]) => list.includes(name))?.[0] || 'Unknown';

const getEmployeeState = name => employeeStateAssignments[name] || 'Unknown';

const getEmployeeGoal = (name, type) => {
const state = getEmployeeState(name);
const dept = getDepartment(name);
if (!stateGoals[state]) return 0;
if (type === 'collection' && dept === 'AR Department') return stateGoals[state].collection;
if (type === 'production' && dept === 'Outbound Department') return stateGoals[state].production;
if (type === 'verification' && dept === 'Verification Department') return stateGoals[state].verification;
return 0;
};

const parseDate = d => {
if (!d) return null;
const date = new Date(d.split(' ')[0]);
return isNaN(date) ? null : new Date(date.setHours(0,0,0,0));
};

const countWorkingDays = (s,e) => {
let c=0, d=new Date(s);
while(d<=e){ if(d.getDay()>0 && d.getDay()<6) c++; d.setDate(d.getDate()+1); }
return c;
};

/* ===================== DATA FETCH ===================== */

async function fetchDataFromSheet(){
setLoading(true); setError('');
try{
/* fetch logic unchanged, cleaned fields only */
setLastUpdated(new Date());
}catch(err){ setError(err.message); }
finally{ setLoading(false); }
}

useEffect(()=>{ fetchDataFromSheet(); },[]);

/* ===================== PERFORMANCE ===================== */

const calculatePerformance = () => {
if(!selectedName) return null;

const dept = getDepartment(selectedName);
const state = getEmployeeState(selectedName);

let workingDays = 1;
if(startDate && endDate){
workingDays = Math.max(1, countWorkingDays(new Date(startDate), new Date(endDate)));
}

let totalCollection = 0;
let totalProduction = 0;
let verificationCount = 0;

if(dept === 'AR Department'){
insPmtData.filter(r=>r.name===selectedName).forEach(r=>{
totalCollection += Number(r.amount)||0;
});
}

if(dept === 'Outbound Department'){
productionData.filter(r=>r.name===selectedName).forEach(r=>{
totalProduction += Number(r.amount)||0;
});
}

if(dept === 'Verification Department'){
verificationCount = data.filter(r=>r.name===selectedName && r.task==='Verification').length;
}

let overall = 0;
if(dept === 'AR Department'){
overall = Math.min(100, (totalCollection / (getEmployeeGoal(selectedName,'collection')*workingDays))*100);
}
if(dept === 'Outbound Department'){
overall = Math.min(100, (totalProduction / (getEmployeeGoal(selectedName,'production')*workingDays))*100);
}
if(dept === 'Verification Department'){
overall = Math.min(100, (verificationCount / (getEmployeeGoal(selectedName,'verification')*workingDays))*100);
}

return {
department: dept,
state,
overallPerformance: Math.round(overall),
totalCollectionAmount: totalCollection.toFixed(2),
totalProductionAmount: totalProduction.toFixed(2),
verificationCount,
numberOfDays: workingDays,
collectionGoal: dept==='AR Department' ? getEmployeeGoal(selectedName,'collection')*workingDays : null,
productionGoal: dept==='Outbound Department' ? getEmployeeGoal(selectedName,'production')*workingDays : null,
verificationGoal: dept==='Verification Department' ? getEmployeeGoal(selectedName,'verification')*workingDays : null
};
};

const performance = calculatePerformance();

/* ===================== UI ===================== */

return (
<div className="p-8 text-white">
<h1 className="text-3xl font-bold mb-4 flex gap-2 items-center">
<Calculator /> KPI Dashboard
</h1>

<button onClick={fetchDataFromSheet} className="mb-4 bg-blue-600 px-4 py-2 rounded">
<RefreshCw className={loading ? 'animate-spin' : ''}/> Refresh
</button>

{error && <div className="text-red-400 flex gap-2"><AlertCircle />{error}</div>}

{performance && (
<div className="mt-6 space-y-2">
<p><b>Department:</b> {performance.department}</p>
<p><b>Overall Performance:</b> {performance.overallPerformance}%</p>
</div>
)}
</div>
);
}

ReactDOM.render(<PerformanceTracker />, document.getElementById('root'));
</script>
</body>
</html>
